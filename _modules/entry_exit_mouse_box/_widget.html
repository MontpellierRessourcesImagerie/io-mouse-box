<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>entry_exit_mouse_box._widget &mdash; Protoplasts swelling analyzer 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=5b94cef0" />

  
    <link rel="shortcut icon" href="../../_static/icon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Protoplasts swelling analyzer
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide.html">Quick Start: A User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../good_practices.html">Good practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Mouse in box functions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Protoplasts swelling analyzer</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">entry_exit_mouse_box._widget</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for entry_exit_mouse_box._widget</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QSlider</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span>
                             <span class="n">QSpinBox</span><span class="p">,</span> <span class="n">QTableWidget</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">,</span> <span class="n">QColorDialog</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span>
                             <span class="n">QGroupBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QFrame</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QFont</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QDoubleValidator</span>
<span class="kn">from</span> <span class="nn">qtpy.QtCore</span> <span class="kn">import</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span>

<span class="kn">import</span> <span class="nn">tifffile</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skimage.draw</span> <span class="kn">import</span> <span class="n">polygon</span>
<span class="kn">from</span> <span class="nn">napari.utils.notifications</span> <span class="kn">import</span> <span class="n">show_info</span><span class="p">,</span> <span class="n">show_error</span><span class="p">,</span> <span class="n">show_warning</span>
<span class="kn">from</span> <span class="nn">napari.utils</span> <span class="kn">import</span> <span class="n">progress</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># if TYPE_CHECKING:</span>
<span class="kn">import</span> <span class="nn">napari</span>
<span class="kn">from</span> <span class="nn">entry_exit_mouse_box.media_manager</span> <span class="kn">import</span> <span class="n">MediaManager</span>
<span class="kn">from</span> <span class="nn">entry_exit_mouse_box.video_mean_processor</span> <span class="kn">import</span> <span class="n">QtWorkerVMP</span>
<span class="kn">from</span> <span class="nn">entry_exit_mouse_box.mask_from_video</span> <span class="kn">import</span> <span class="n">QtWorkerMFV</span>
<span class="kn">from</span> <span class="nn">entry_exit_mouse_box.measures</span> <span class="kn">import</span> <span class="n">QtWorkerMVP</span>
<span class="kn">from</span> <span class="nn">entry_exit_mouse_box.utils</span> <span class="kn">import</span> <span class="n">setup_logger</span><span class="p">,</span> <span class="n">smooth_path_2d</span><span class="p">,</span> <span class="n">apply_lut</span>
<span class="kn">from</span> <span class="nn">entry_exit_mouse_box.results_table</span> <span class="kn">import</span> <span class="n">SessionsResultsTable</span><span class="p">,</span> <span class="n">FrameWiseResultsTable</span>


<span class="n">BG_REF_LAYER</span>      <span class="o">=</span> <span class="s2">&quot;bg_ref&quot;</span>
<span class="n">MICE_LABELS_LAYER</span> <span class="o">=</span> <span class="s2">&quot;mice_labels&quot;</span>
<span class="n">AREAS_LAYER</span>       <span class="o">=</span> <span class="s2">&quot;areas&quot;</span>
<span class="n">MEDIA_LAYER</span>       <span class="o">=</span> <span class="s2">&quot;media&quot;</span>
<span class="n">TS_PREVIEW_LAYER</span>  <span class="o">=</span> <span class="s2">&quot;threshold_preview&quot;</span> 
<span class="n">CENTOIDS_LAYER</span>    <span class="o">=</span> <span class="s2">&quot;centroids&quot;</span>
<span class="n">PATH_LAYER</span>        <span class="o">=</span> <span class="s2">&quot;path&quot;</span>
<span class="n">FONT</span>              <span class="o">=</span> <span class="n">QFont</span><span class="p">()</span>
<span class="n">FONT</span><span class="o">.</span><span class="n">setFamily</span><span class="p">(</span><span class="s2">&quot;Arial Unicode MS, Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="MouseInOutWidget">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget">[docs]</a>
<span class="k">class</span> <span class="nc">MouseInOutWidget</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>

    <span class="n">background_ready</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">tracking_ready</span>   <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
    <span class="n">measures_ready</span>   <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">napari_viewer</span><span class="p">:</span> <span class="s2">&quot;napari.Viewer&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># List containing the names of layers containing the boxes. (the polygons)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Instance of Napari viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span> <span class="o">=</span> <span class="n">napari_viewer</span>
        <span class="c1"># Object managing the media sources (reading and synchronizing the frames, the masks, the labels, ...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span>     <span class="o">=</span> <span class="n">MediaManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="p">)</span>
        <span class="c1"># Dictionary containing the frame at which we start the measures for each box.</span>
        <span class="c1"># The key is the index of the row in the table, the value is the frame index.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Instance of the logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Should path be hidden.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths_hidden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Table containing the visibility status. [nBoxes, totalFrames] -&gt; uint8</span>
        <span class="c1"># | -1: Mouse not present yet.</span>
        <span class="c1"># |  0: Mouse not visible.</span>
        <span class="c1"># |  1: Mouse visible.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span>   <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Table containing the number of times the mouse entered and exited the box. [nBoxes] -&gt; uint32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_out_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Table containing the sessions. [nBoxes, nSessions, 4] -&gt; float</span>
        <span class="c1"># | [0] Frame at which the session starts.</span>
        <span class="c1"># | [1] Duration of the session in seconds.</span>
        <span class="c1"># | [2] Duration of the session in frames.</span>
        <span class="c1"># | [3] Distance traveled by the mouse during this session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Table containing the centroids of the mice. [totalFrames, nBoxes, 2] -&gt; float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Lists of results tables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames_results</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Path of the directory containing the temporary files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Calibration of the image.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_temp_dir</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">switch_log_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H%M&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.log&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_calibration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_ui</span><span class="p">()</span>

<div class="viewcode-block" id="MouseInOutWidget.init_ui">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.init_ui">[docs]</a>
    <span class="k">def</span> <span class="nf">init_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_video_control_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_duration_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_media_control_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_calibration_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tracking_ui</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.add_video_control_ui">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.add_video_control_ui">[docs]</a>
    <span class="k">def</span> <span class="nf">add_video_control_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">group_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Video Control&quot;</span><span class="p">)</span>
        <span class="n">layout</span>    <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">group_box</span><span class="p">)</span>

        <span class="c1"># Clear state button.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_state_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;✨ Clear state&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_state_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_state_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_state</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_state_button</span><span class="p">)</span>

        <span class="c1"># Vertical spacing</span>
        <span class="n">spacer</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="n">spacer</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># Width, Height</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spacer</span><span class="p">)</span>

        <span class="c1"># Button to select the video.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;📁 Select File&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_file</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_button</span><span class="p">)</span>

        <span class="c1"># Buttons &#39;backward&#39; and &#39;forward&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;⏮️ Backward&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jump_backward</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forward_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Forward ⏭️&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jump_forward</span><span class="p">)</span>
        
        <span class="n">nav_layout_2</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">nav_layout_2</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backward_button</span><span class="p">)</span>
        <span class="n">nav_layout_2</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_button</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">nav_layout_2</span><span class="p">)</span>

        <span class="c1"># Slider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_slider_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setOrientation</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="p">)</span>

        <span class="c1"># Slot d&#39;entier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_spinbox_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setPrefix</span><span class="p">(</span><span class="s2">&quot;Frame: &quot;</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="p">)</span>

        <span class="c1"># Vertical spacing</span>
        <span class="n">spacer</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="n">spacer</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># Width, Height</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spacer</span><span class="p">)</span>

        <span class="c1"># Video name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_name</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;---&lt;/b&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_name</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Panel</span> <span class="o">|</span> <span class="n">QFrame</span><span class="o">.</span><span class="n">Sunken</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_name</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_name</span><span class="p">)</span>

        <span class="c1"># Time in seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;0 sec&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_label</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Panel</span> <span class="o">|</span> <span class="n">QFrame</span><span class="o">.</span><span class="n">Sunken</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info_label</span><span class="p">)</span>

        <span class="c1"># Video properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties_display</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;0x0 (0 FPS) ↦ 0s&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties_display</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Panel</span> <span class="o">|</span> <span class="n">QFrame</span><span class="o">.</span><span class="n">Sunken</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties_display</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties_display</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">group_box</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.experiment_duration_ui">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.experiment_duration_ui">[docs]</a>
    <span class="k">def</span> <span class="nf">experiment_duration_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Group box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupBox</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Experiment duration&quot;</span><span class="p">)</span>
        <span class="n">groupBoxLayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="c1"># Spin boxes and labels layout</span>
        <span class="n">entryLayout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        
        <span class="c1"># Spin boxes and labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minutesSpin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minutesSpin</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minutesSpin</span><span class="o">.</span><span class="n">setSuffix</span><span class="p">(</span><span class="s1">&#39; min&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minutesSpin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">secondsSpin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondsSpin</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">59</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondsSpin</span><span class="o">.</span><span class="n">setSuffix</span><span class="p">(</span><span class="s1">&#39; sec&#39;</span><span class="p">)</span>

        <span class="c1"># Adding widgets to the entry layout</span>
        <span class="n">entryLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minutesSpin</span><span class="p">)</span>
        <span class="n">entryLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondsSpin</span><span class="p">)</span>

        <span class="c1"># Add entry layout to group box layout</span>
        <span class="n">groupBoxLayout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">entryLayout</span><span class="p">)</span>

        <span class="c1"># Set group box layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupBox</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">groupBoxLayout</span><span class="p">)</span>
        
        <span class="c1"># Add group box to main layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupBox</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.duration_to_frames">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.duration_to_frames">[docs]</a>
    <span class="k">def</span> <span class="nf">duration_to_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minutesSpin</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondsSpin</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">seconds</span><span class="p">)</span> <span class="o">*</span> <span class="n">fps</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.add_media_control_ui">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.add_media_control_ui">[docs]</a>
    <span class="k">def</span> <span class="nf">add_media_control_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">group_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Box Control&quot;</span><span class="p">)</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">group_box</span><span class="p">)</span>

        <span class="c1"># Boutons add et pop</span>
        <span class="n">btn_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_box_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;🔵 Add Box&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_box_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_box_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_row</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_box_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;❌ Pop Box&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_box_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_box_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_row</span><span class="p">)</span>

        <span class="n">btn_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_box_button</span><span class="p">)</span>
        <span class="n">btn_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_box_button</span><span class="p">)</span>
        
        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">btn_layout</span><span class="p">)</span>

        <span class="c1"># Tableau</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Start&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="c1"># self.table.horizontalHeader().setStretchLastSection(True)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span>
        <span class="n">header</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">itemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_table_item_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">group_box</span><span class="p">)</span></div>



<div class="viewcode-block" id="MouseInOutWidget.update_calibration">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.update_calibration">[docs]</a>
    <span class="k">def</span> <span class="nf">update_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pixelSize</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixelSize</span><span class="p">,</span> <span class="n">pixelSize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span></div>


    
<div class="viewcode-block" id="MouseInOutWidget.add_calibration_ui">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.add_calibration_ui">[docs]</a>
    <span class="k">def</span> <span class="nf">add_calibration_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationGroup</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Calibration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationLayout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="n">nav_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="c1"># Create QLineEdit for float input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibInput</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="n">float_validator</span> <span class="o">=</span> <span class="n">QDoubleValidator</span><span class="p">()</span>
        <span class="n">float_validator</span><span class="o">.</span><span class="n">setNotation</span><span class="p">(</span><span class="n">QDoubleValidator</span><span class="o">.</span><span class="n">StandardNotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibInput</span><span class="o">.</span><span class="n">setValidator</span><span class="p">(</span><span class="n">float_validator</span><span class="p">)</span>
        <span class="n">nav_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibInput</span><span class="p">)</span>

        <span class="c1"># Create QComboBox for unit selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitSelector</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="s2">&quot;cm&quot;</span><span class="p">,</span> <span class="s2">&quot;dm&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">]</span>  <span class="c1"># Define the units from nanometers to meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitSelector</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">nav_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unitSelector</span><span class="p">)</span>

        <span class="c1"># Add the nav_layout to the calibration layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationLayout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">nav_layout</span><span class="p">)</span>

        <span class="c1"># Apply calibration button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationButton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;📏 Apply calibration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationButton</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_calibration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibrationButton</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationGroup</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibrationLayout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibrationGroup</span><span class="p">)</span></div>



<div class="viewcode-block" id="MouseInOutWidget.add_tracking_ui">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.add_tracking_ui">[docs]</a>
    <span class="k">def</span> <span class="nf">add_tracking_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">group_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Tracking&quot;</span><span class="p">)</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">group_box</span><span class="p">)</span>

        <span class="n">size_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_min_area_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;📏 Set area&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_min_area_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_min_area_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_min_area</span><span class="p">)</span>
        <span class="n">size_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_min_area_button</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">min_area</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_area</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_area</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
        <span class="n">size_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_area</span><span class="p">)</span>

        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">size_layout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extract_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;♻️ Clear background&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_extract_background</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_button</span><span class="p">)</span>

        <span class="n">track_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">track_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;🐀 Launch tracking&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_tracking</span><span class="p">)</span>
        <span class="n">track_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_button</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_threshold_update</span><span class="p">)</span>
        <span class="n">track_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>

        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">track_layout</span><span class="p">)</span>

        <span class="n">measure_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extract_measures_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;📐 Measure&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_measures_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_measures_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_measures</span><span class="p">)</span>
        <span class="n">measure_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_measures_button</span><span class="p">)</span>

        <span class="c1"># Checkbox to hide and stop refreshing the paths:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_path_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="s2">&quot;Hide paths&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_path_checkbox</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_paths</span><span class="p">)</span>
        <span class="n">measure_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_path_checkbox</span><span class="p">)</span>

        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">measure_layout</span><span class="p">)</span>

        <span class="c1"># Button to export the results.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;📤 Create results tables&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_button</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">FONT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_results</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_button</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">group_box</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="MouseInOutWidget.apply_calibration">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.apply_calibration">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying calibration...&quot;</span><span class="p">)</span>
        <span class="c1"># Checking that there is an active layer and that is a shape layer containing a unique line.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span>
        <span class="k">if</span> <span class="s1">&#39;shape_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">shape_types</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape_type</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_types</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">shape_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># in pixels</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibInput</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">))</span>
        <span class="n">pixelSize</span> <span class="o">=</span> <span class="n">length</span> <span class="o">/</span> <span class="n">distance</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitSelector</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_calibration</span><span class="p">(</span><span class="n">pixelSize</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">name</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>



<div class="viewcode-block" id="MouseInOutWidget.set_calibration">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.set_calibration">[docs]</a>
    <span class="k">def</span> <span class="nf">set_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelSize</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixelSize</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixelSize</span><span class="p">,</span> <span class="n">pixelSize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibration applied: </span><span class="si">{</span><span class="n">pixelSize</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2"> per pixel.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="MouseInOutWidget.hide_paths">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.hide_paths">[docs]</a>
    <span class="k">def</span> <span class="nf">hide_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">PATH_LAYER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">PATH_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_boxes</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.set_min_area">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.set_min_area">[docs]</a>
    <span class="k">def</span> <span class="nf">set_min_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses a polygon drawn by the user over the head of a mouse to define the minimal area to consider that a mouse is present.</span>
<span class="sd">        When summoned, this function must find a shape layer as the active layer, and extract the area of the polygon.</span>
<span class="sd">        The shape layer is then deleted.</span>
<span class="sd">        The value extracted is not stored, it is written in the spinbox.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Checking required ressources (media and shape layer).</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">active</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_n_sources</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;No media opened.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No media opened.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;No layer selected.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No layer selected.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># The active layer must be the shape layer, containing a polygon around the head of a mouse.</span>
        <span class="n">active_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span>
        <span class="n">active_layer</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">MEDIA_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># Checking that the active layer is a shape layer.</span>
        <span class="k">if</span> <span class="s1">&#39;add_lines&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">active_layer</span><span class="p">):</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;A shape layer is expected.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;A shape layer is expected.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Checking that the shape layer is not empty.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_layer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;No data in the layer.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No data in the layer.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">shape</span> <span class="o">=</span> <span class="n">active_layer</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;The shape must be a polygon.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The shape must be a polygon.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">area_pixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">area</span><span class="p">)</span> <span class="c1"># in number of pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_area</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">area_pixels</span><span class="p">)</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">active_layer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">MEDIA_LAYER</span><span class="p">]</span></div>


<div class="viewcode-block" id="MouseInOutWidget.on_threshold_update">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.on_threshold_update">[docs]</a>
    <span class="k">def</span> <span class="nf">on_threshold_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a preview layer showing what the mask would be for the current frame for a given threshold.</span>
<span class="sd">        Updates are made only when the threshold is edited.</span>
<span class="sd">        The background reference is required.</span>
<span class="sd">        The produced layer is named &#39;threshold_preview&#39; and is temporary, it will be discarded.</span>
<span class="sd">        This function is the callback for the threshold spinbox.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: int - The threshold value to use for the preview.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">BG_REF_LAYER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">show_warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find the background reference.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find the background reference. Layers list: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">]))</span>
            <span class="k">return</span>
        
        <span class="n">bg_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">BG_REF_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">img</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">MEDIA_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">diff</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="n">bg_ref</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">TS_PREVIEW_LAYER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">TS_PREVIEW_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">diff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
                <span class="n">diff</span><span class="p">,</span> 
                <span class="n">name</span><span class="o">=</span><span class="n">TS_PREVIEW_LAYER</span><span class="p">,</span>
                <span class="n">blending</span><span class="o">=</span><span class="s2">&quot;translucent&quot;</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.toggle_inputs">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.toggle_inputs">[docs]</a>
    <span class="k">def</span> <span class="nf">toggle_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to disable the inputs (buttons and text fields) when a long process is running.</span>

<span class="sd">        Args:</span>
<span class="sd">            t: bool - True to enable the inputs, False to disable them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_box_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_box_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_state_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_measures_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_min_area_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_area</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_path_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibInput</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibInput</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitSelector</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrationButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minutesSpin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondsSpin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.switch_log_file">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.switch_log_file">[docs]</a>
    <span class="k">def</span> <span class="nf">switch_log_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new log file when we switch to a new experiment video.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">new_file_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.make_start_frame">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.make_start_frame">[docs]</a>
    <span class="k">def</span> <span class="nf">make_start_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the frame at which we start measures from the current frame being displayed.</span>
<span class="sd">        The saved index is the one displayed on the screen. (The real one + 1).</span>
<span class="sd">        A source is required before we can set the start frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_n_sources</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_to_frames</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_n_frames</span><span class="p">():</span>
            <span class="n">show_warning</span><span class="p">(</span><span class="s2">&quot;The duration of the experiment exceeds the total number of frames.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The duration of the experiment exceeds the total number of frames.&quot;</span><span class="p">)</span>
        <span class="n">button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;▸ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="MouseInOutWidget.on_table_item_changed">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.on_table_item_changed">[docs]</a>
    <span class="k">def</span> <span class="nf">on_table_item_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the user modifies an existing line of the table containing the colors and names of the boxes.</span>
<span class="sd">        The new name is processed here before it is provided by the user.</span>
<span class="sd">        Both the layer&#39;s name and the box&#39;s name are updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span> <span class="c1"># The line is being added</span>
            <span class="k">return</span>
        
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The name of the box is too short.&quot;</span><span class="p">)</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Box-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Box </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()</span><span class="si">}</span><span class="s2"> renamed to: </span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()]]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">row</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_name</span></div>

    
<div class="viewcode-block" id="MouseInOutWidget.select_color">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.select_color">[docs]</a>
    <span class="k">def</span> <span class="nf">select_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">button</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QColorDialog</span><span class="o">.</span><span class="n">getColor</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">k</span>
        
        <span class="k">if</span> <span class="n">color</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="n">button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;background-color: </span><span class="si">{</span><span class="n">color</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">)</span>
            <span class="n">button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span><span class="o">.</span><span class="n">edge_color</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span><span class="o">.</span><span class="n">edge_color</span> <span class="o">=</span> <span class="p">[</span><span class="n">color</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span><span class="o">.</span><span class="n">current_edge_color</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">name</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.add_row">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.add_row">[docs]</a>
    <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_n_sources</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;No media opened.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No media opened.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">row_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Box-</span><span class="si">{</span><span class="n">row_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Adding color picker to the table</span>
        <span class="n">color_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Pick a color&#39;</span><span class="p">)</span>
        <span class="n">color_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_color</span><span class="p">(</span><span class="n">row_count</span><span class="p">,</span> <span class="n">color_button</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">row_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color_button</span><span class="p">)</span>
        <span class="c1"># Adding the name slot to the table</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Box-</span><span class="si">{</span><span class="n">row_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="c1"># Adding the start frame slot to the table</span>
        <span class="n">start_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;▸ --&quot;</span><span class="p">)</span>
        <span class="n">start_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_start_frame</span><span class="p">(</span><span class="n">row_count</span><span class="p">,</span> <span class="n">start_button</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">row_count</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">start_button</span><span class="p">)</span>
        <span class="c1"># Adding the layer containing the shape</span>
        <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Box-</span><span class="si">{</span><span class="n">row_count</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">add_shapes</span><span class="p">([],</span> <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">shape_type</span><span class="o">=</span><span class="s1">&#39;polygon&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edge_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#aaaaaaff&#39;</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="s1">&#39;#00000000&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;add_rectangle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Box </span><span class="si">{</span><span class="n">row_count</span><span class="si">}</span><span class="s2"> added.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.remove_row">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.remove_row">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">row_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="n">row_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">pop</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Box </span><span class="si">{</span><span class="n">row_count</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> removed.&quot;</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="n">row_count</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="MouseInOutWidget.extract_measures">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.extract_measures">[docs]</a>
    <span class="k">def</span> <span class="nf">extract_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_inputs</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">show_info</span><span class="p">(</span><span class="s2">&quot;Extracting measures...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting measures...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span> <span class="o">=</span> <span class="n">progress</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Extracting measures...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>

        <span class="n">mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">MICE_LABELS_LAYER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">AREAS_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_area</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mvp</span> <span class="o">=</span> <span class="n">QtWorkerMVP</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_to_frames</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvp</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvp</span><span class="o">.</span><span class="n">measures_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminate_measures</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mvp</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.terminate_measures">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.terminate_measures">[docs]</a>
    <span class="k">def</span> <span class="nf">terminate_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">,</span> <span class="n">in_out_count</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span> <span class="n">centroids</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Measures extracted.&quot;</span><span class="p">)</span>
        <span class="n">show_info</span><span class="p">(</span><span class="s2">&quot;Measures extracted!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_inputs</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span>   <span class="o">=</span> <span class="n">visibility</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;visibility.npy&quot;</span><span class="p">),</span> <span class="n">visibility</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_out_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">in_out_count</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;in_out_count.npy&quot;</span><span class="p">),</span> <span class="n">in_out_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span>     <span class="o">=</span> <span class="n">sessions</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;sessions.npy&quot;</span><span class="p">),</span> <span class="n">sessions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span>    <span class="o">=</span> <span class="n">centroids</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;centroids.npy&quot;</span><span class="p">),</span> <span class="n">centroids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_boxes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measures_ready</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.export_results">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.export_results">[docs]</a>
    <span class="k">def</span> <span class="nf">export_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">edge_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">])</span>

        <span class="c1"># Centroids, visibility, name of boxes</span>
        <span class="n">fwrt</span> <span class="o">=</span> <span class="n">FrameWiseResultsTable</span><span class="p">((</span>
            <span class="n">colors</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span>
        <span class="p">))</span>
        <span class="n">fwrt</span><span class="o">.</span><span class="n">set_exp_name</span><span class="p">(</span><span class="s2">&quot;frames-&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">MEDIA_LAYER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">fwrt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwrt</span><span class="p">)</span>

        <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_results</span><span class="p">()</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;px&quot;</span> <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">srt</span> <span class="o">=</span> <span class="n">SessionsResultsTable</span><span class="p">((</span>
            <span class="n">colors</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">in_out_count</span><span class="p">,</span> 
            <span class="n">sessions</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span><span class="p">,</span>
            <span class="n">unit</span>
        <span class="p">))</span>
        <span class="n">srt</span><span class="o">.</span><span class="n">set_exp_name</span><span class="p">(</span><span class="s2">&quot;sessions-&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">MEDIA_LAYER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">srt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srt</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.calibrate_results">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.calibrate_results">[docs]</a>
    <span class="k">def</span> <span class="nf">calibrate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the calibration to the distance traveled by the mice, stored in the sessions table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Checking if the image is calibrated.</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">show_warning</span><span class="p">(</span><span class="s2">&quot;No calibration found, exporting distances in pixels.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No calibration found, exporting distances in pixels.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sessions</span>
        
        <span class="c1"># Get the size of a pixel.</span>
        <span class="n">pixel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">MEDIA_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">show_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibration found: XY=</span><span class="si">{</span><span class="n">pixel_size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">scale_bar</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_out_count</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">sessions</span><span class="p">[</span><span class="n">box</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">pixel_size</span>
        
        <span class="k">return</span> <span class="n">sessions</span></div>

    
<div class="viewcode-block" id="MouseInOutWidget.create_temp_dir">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.create_temp_dir">[docs]</a>
    <span class="k">def</span> <span class="nf">create_temp_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
            <span class="k">return</span>
        
        <span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
            <span class="n">show_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parent directory &#39;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&#39; does not exist. Working in `tmp` directory.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">show_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory &#39;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">&#39; already exists. All its content will be deleted.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">root</span></div>


<div class="viewcode-block" id="MouseInOutWidget.update_boxes">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.update_boxes">[docs]</a>
    <span class="k">def</span> <span class="nf">update_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ajouter un layer sur lequel on écrit la durée de la session.</span>
        <span class="c1"># Changer la couleur des boxes en fonction de la visibilité.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_face_color</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_centroids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_mice_path</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.update_face_color">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.update_face_color">[docs]</a>
    <span class="k">def</span> <span class="nf">update_face_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">b_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">b_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span><span class="p">[</span><span class="n">lbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;#29b0ff50&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span><span class="p">[</span><span class="n">lbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;#ff292950&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span><span class="p">[</span><span class="n">lbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;#aaaaaaaa&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;#000000ff&#39;</span></div>

        
<div class="viewcode-block" id="MouseInOutWidget.update_centroids">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.update_centroids">[docs]</a>
    <span class="k">def</span> <span class="nf">update_centroids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">frame_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">CENTOIDS_LAYER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">CENTOIDS_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">frame_points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span>
                <span class="n">frame_points</span><span class="p">,</span> 
                <span class="n">name</span><span class="o">=</span><span class="n">CENTOIDS_LAYER</span><span class="p">,</span> 
                <span class="n">face_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
                <span class="n">size</span><span class="o">=</span><span class="mi">6</span>
            <span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">CENTOIDS_LAYER</span><span class="p">]</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">edge_color</span> <span class="o">=</span> <span class="s1">&#39;#00000000&#39;</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">)):</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#ff0000ff&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span><span class="p">[</span><span class="n">box</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;#00000000&quot;</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">face_color</span> <span class="o">=</span> <span class="n">colors</span></div>


<div class="viewcode-block" id="MouseInOutWidget.update_mice_path">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.update_mice_path">[docs]</a>
    <span class="k">def</span> <span class="nf">update_mice_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths_hidden</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">full_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">b_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span><span class="p">[</span><span class="n">lbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Finding the session index for this box.</span>
            <span class="c1"># A session starts at the first frame where the visibility is 1.</span>
            <span class="n">session_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">lbl</span><span class="p">,</span> <span class="n">session_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="p">:</span>
                <span class="n">session_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">session_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">lbl</span><span class="p">]):</span>
                    <span class="k">break</span>
            <span class="c1"># Reading the duration in seconds and in frames.</span>
            <span class="n">session_index</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">duration_f</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">lbl</span><span class="p">,</span> <span class="n">session_index</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">frame_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">lbl</span><span class="p">,</span> <span class="n">session_index</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">smooth_path_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centroids</span><span class="p">[</span><span class="n">frame_start</span><span class="p">:</span><span class="n">frame_start</span><span class="o">+</span><span class="n">duration_f</span><span class="p">,</span> <span class="n">lbl</span><span class="p">][::</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span><span class="o">/</span><span class="mi">6</span><span class="p">)])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">full_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PATH_LAYER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">PATH_LAYER</span><span class="p">]</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">full_path</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">shape_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;path&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">add_shapes</span><span class="p">(</span>
                <span class="n">full_path</span><span class="p">,</span> 
                <span class="n">name</span><span class="o">=</span><span class="n">PATH_LAYER</span><span class="p">,</span> 
                <span class="n">shape_type</span><span class="o">=</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> 
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
                <span class="n">edge_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#ff0000ff&#39;</span><span class="p">,</span> 
                <span class="n">face_color</span><span class="o">=</span><span class="s1">&#39;#00000000&#39;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.clear_state">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.clear_state">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the state of the widget to its initial state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_name</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;---&lt;/b&gt;&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_playback_info</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">f_r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames_results</span><span class="p">:</span>
            <span class="n">f_r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s_r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_results</span><span class="p">:</span>
            <span class="n">s_r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions_results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_out_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centroids</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mfv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Widget cleared.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.select_file">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.select_file">[docs]</a>
    <span class="k">def</span> <span class="nf">select_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Select a video&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No file selected.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_media</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="MouseInOutWidget.set_media">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.set_media">[docs]</a>
    <span class="k">def</span> <span class="nf">set_media</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">bgr2rgb</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        
        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">MEDIA_LAYER</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">bgr2rgb</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to open the file: &quot;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;total_frames&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;total_frames&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_playback_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_name</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/b&gt;&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File opened: &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Properties: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">properties</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_temp_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span> 
            <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span></div>

    
<div class="viewcode-block" id="MouseInOutWidget.update_playback_info">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.update_playback_info">[docs]</a>
    <span class="k">def</span> <span class="nf">update_playback_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_fps</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_n_frames</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">nf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span>
        
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">/</span> <span class="n">fps</span> <span class="k">if</span> <span class="n">nf</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">nf</span> <span class="o">/</span> <span class="n">fps</span><span class="p">)</span> <span class="k">if</span> <span class="n">nf</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties_display</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">fps</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> FPS) ↦ </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="MouseInOutWidget.set_frame">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.set_frame">[docs]</a>
    <span class="k">def</span> <span class="nf">set_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_playback_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_boxes</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.jump_backward">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.jump_backward">[docs]</a>
    <span class="k">def</span> <span class="nf">jump_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="o">-</span><span class="mi">25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.jump_forward">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.jump_forward">[docs]</a>
    <span class="k">def</span> <span class="nf">jump_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">current_frame</span><span class="o">+</span><span class="mi">25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.on_slider_change">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.on_slider_change">[docs]</a>
    <span class="k">def</span> <span class="nf">on_slider_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_input</span><span class="o">.</span><span class="n">value</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.on_spinbox_change">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.on_spinbox_change">[docs]</a>
    <span class="k">def</span> <span class="nf">on_spinbox_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">value</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.start_extract_background">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.start_extract_background">[docs]</a>
    <span class="k">def</span> <span class="nf">start_extract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">MEDIA_LAYER</span><span class="p">)</span>
        <span class="n">src_path</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_inputs</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">show_info</span><span class="p">(</span><span class="s2">&quot;Extracting background...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting background...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span> <span class="o">=</span> <span class="n">progress</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Extracting background...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmp</span> <span class="o">=</span> <span class="n">QtWorkerVMP</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_width</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmp</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmp</span><span class="o">.</span><span class="n">bg_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminate_extract_background</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vmp</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="MouseInOutWidget.terminate_extract_background">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.terminate_extract_background">[docs]</a>
    <span class="k">def</span> <span class="nf">terminate_extract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">src_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">BG_REF_LAYER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">BG_REF_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
                <span class="n">ref</span><span class="p">,</span> 
                <span class="n">name</span><span class="o">=</span><span class="n">BG_REF_LAYER</span><span class="p">,</span> 
                <span class="n">visible</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;bg-ref.tif&quot;</span><span class="p">),</span> <span class="n">ref</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Background extracted.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Background reference saved in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">show_info</span><span class="p">(</span><span class="s2">&quot;Background extracted!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_inputs</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background_ready</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="MouseInOutWidget.extract_classes">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.extract_classes">[docs]</a>
    <span class="k">def</span> <span class="nf">extract_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="n">color_button_widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color_button_widget</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">color_button_widget</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span><span class="o">.</span><span class="n">button</span><span class="p">()</span><span class="o">.</span><span class="n">color</span><span class="p">()</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">red</span><span class="p">(),</span> <span class="n">color</span><span class="o">.</span><span class="n">green</span><span class="p">(),</span> <span class="n">color</span><span class="o">.</span><span class="n">blue</span><span class="p">(),</span> <span class="mi">255</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

            <span class="n">class_name_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_name_item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="n">class_name_item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">classes</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span>
            
        <span class="k">return</span> <span class="n">classes</span></div>

    
<div class="viewcode-block" id="MouseInOutWidget.build_labels_from_polygon">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.build_labels_from_polygon">[docs]</a>
    <span class="k">def</span> <span class="nf">build_labels_from_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">canvas_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_width</span><span class="p">())</span>
        <span class="n">label_areas</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">canvas_shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">b_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">):</span>
            <span class="n">shape_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">b_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_layer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data in the layer: </span><span class="si">{</span><span class="n">b_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;box-</span><span class="si">{</span><span class="n">b_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">),</span> <span class="n">shape_layer</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape_layer</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">polygon</span><span class="p">(</span><span class="n">shape</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">canvas_shape</span><span class="p">)</span>
            <span class="n">label_areas</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># Build a path to export the labels</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;labeled-areas.tif&quot;</span><span class="p">),</span> <span class="n">label_areas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Labels (regions) saved in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">AREAS_LAYER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">AREAS_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">label_areas</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span>
                <span class="n">label_areas</span><span class="p">,</span> 
                <span class="n">name</span><span class="o">=</span><span class="n">AREAS_LAYER</span><span class="p">,</span> 
                <span class="n">visible</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="MouseInOutWidget.launch_mask_processing">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.launch_mask_processing">[docs]</a>
    <span class="k">def</span> <span class="nf">launch_mask_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Acquiring the background reference.</span>
        <span class="k">if</span> <span class="n">BG_REF_LAYER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find the background reference. Abort.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">bg_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">BG_REF_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Checking that all the start frames are set.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not all boxes have a start frame set.&quot;</span><span class="p">)</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;Not all boxes have a start frame set.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Building the output path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_n_sources</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No media opened.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">media_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">get_source_by_name</span><span class="p">(</span><span class="n">MEDIA_LAYER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;mask.avi&quot;</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

        <span class="c1"># Removing threshold previewer</span>
        <span class="k">if</span> <span class="n">TS_PREVIEW_LAYER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">TS_PREVIEW_LAYER</span><span class="p">]</span>

        <span class="c1"># Launching the worker...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_inputs</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">show_info</span><span class="p">(</span><span class="s2">&quot;Building mice labels...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Building mice labels with threshold at: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">value</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Building mice labels from frame: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span> <span class="o">=</span> <span class="n">progress</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Building mice labels...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mfv</span> <span class="o">=</span> <span class="n">QtWorkerMFV</span><span class="p">(</span>
            <span class="n">media_path</span><span class="p">,</span> 
            <span class="n">output_path</span><span class="p">,</span> 
            <span class="n">bg_ref</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">AREAS_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mfv</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mfv</span><span class="o">.</span><span class="n">mask_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminate_mask_processing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mfv</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

        

<div class="viewcode-block" id="MouseInOutWidget.terminate_mask_processing">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.terminate_mask_processing">[docs]</a>
    <span class="k">def</span> <span class="nf">terminate_mask_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_path</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">bgr2rgb_tr</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">127</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">canvas</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">AREAS_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">canvas</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">MICE_LABELS_LAYER</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">bgr2rgb_tr</span><span class="p">)</span>
        <span class="n">apply_lut</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">MICE_LABELS_LAYER</span><span class="p">],</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_classes</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">MEDIA_LAYER</span><span class="p">]</span><span class="o">.</span><span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_inputs</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mice labels built.&quot;</span><span class="p">)</span>
        <span class="n">show_info</span><span class="p">(</span><span class="s2">&quot;Mice labels built!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_inputs</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracking_ready</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>


<div class="viewcode-block" id="MouseInOutWidget.dump_table">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.dump_table">[docs]</a>
    <span class="k">def</span> <span class="nf">dump_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the content of the table in a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">color_button_widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color_button_widget</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">color_button_widget</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span><span class="o">.</span><span class="n">button</span><span class="p">()</span><span class="o">.</span><span class="n">color</span><span class="p">()</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">red</span><span class="p">(),</span> <span class="n">color</span><span class="o">.</span><span class="n">green</span><span class="p">(),</span> <span class="n">color</span><span class="o">.</span><span class="n">blue</span><span class="p">(),</span> <span class="mi">255</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span>

            <span class="n">class_name_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_name_item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">if</span> <span class="n">class_name_item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_name</span>

            <span class="n">start_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_frame</span>

            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        
        <span class="n">stringified</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;boxes.json&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stringified</span><span class="p">)</span></div>


<div class="viewcode-block" id="MouseInOutWidget.launch_tracking">
<a class="viewcode-back" href="../../mouse_in_box.html#entry_exit_mouse_box.MouseInOutWidget.launch_tracking">[docs]</a>
    <span class="k">def</span> <span class="nf">launch_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">show_error</span><span class="p">(</span><span class="s2">&quot;No boxes to track.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No boxes to track.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Building the labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_labels_from_polygon</span><span class="p">()</span>
        <span class="n">apply_lut</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">AREAS_LAYER</span><span class="p">],</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_classes</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_mask_processing</span><span class="p">()</span></div>
</div>




<span class="c1"># ---------------------------- TEST PROCEDURE ----------------------------</span>

<span class="k">def</span> <span class="nf">launch_test_procedure_1</span><span class="p">():</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
    <span class="n">miow</span>   <span class="o">=</span> <span class="n">MouseInOutWidget</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">add_dock_widget</span><span class="p">(</span><span class="n">miow</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Workflow: WIN_20210830_11_11_50_Pro.mp4 ---&quot;</span><span class="p">)</span>

    <span class="n">media_path</span> <span class="o">=</span> <span class="s2">&quot;/home/benedetti/Documents/projects/25-entry-exit-mouse-monitor/data-samples/WIN_20210830_11_11_50_Pro.mp4&quot;</span>

    <span class="c1"># Set experimental video.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">set_media</span><span class="p">(</span><span class="n">media_path</span><span class="p">)</span>

    <span class="c1"># Add boxes...</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="mf">158.30374768</span><span class="p">,</span> <span class="mf">178.23561088</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">158.30374768</span><span class="p">,</span> <span class="mf">271.26936533</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">276.3426219</span> <span class="p">,</span> <span class="mf">271.26936533</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">276.3426219</span> <span class="p">,</span> <span class="mf">178.23561088</span><span class="p">]])</span>
    
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="mf">156.83285828</span><span class="p">,</span> <span class="mf">277.88836762</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">156.83285828</span><span class="p">,</span> <span class="mf">374.96706791</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">274.8717325</span> <span class="p">,</span> <span class="mf">374.96706791</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">274.8717325</span> <span class="p">,</span> <span class="mf">277.88836762</span><span class="p">]])</span>
    
    <span class="n">b3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="mf">157.93602533</span><span class="p">,</span> <span class="mf">380.48290316</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">157.93602533</span><span class="p">,</span> <span class="mf">477.1938811</span> <span class="p">],</span>
        <span class="p">[</span><span class="mf">274.1362878</span> <span class="p">,</span> <span class="mf">477.1938811</span> <span class="p">],</span>
        <span class="p">[</span><span class="mf">274.1362878</span> <span class="p">,</span> <span class="mf">380.48290316</span><span class="p">]])</span>
    
    <span class="n">boxes</span>  <span class="o">=</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">]</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#ff0000&#39;</span><span class="p">,</span> <span class="s1">&#39;#00ff00&#39;</span><span class="p">,</span> <span class="s1">&#39;#0000ff&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">boxes</span><span class="p">)):</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">add_row</span><span class="p">()</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">]</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">make_start_frame</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> 
            <span class="n">miow</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">select_color</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> 
            <span class="n">miow</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
            <span class="n">QColor</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="p">)</span>


    <span class="c1"># Setting min area and threshold value for the mask.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">min_area</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">76</span><span class="p">)</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">75</span><span class="p">)</span>

    <span class="c1"># Launch the tracking after the background extraction</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">background_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">miow</span><span class="o">.</span><span class="n">launch_tracking</span><span class="p">)</span>
    <span class="c1"># Launch measures extraction after the tracking was done.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">tracking_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">miow</span><span class="o">.</span><span class="n">extract_measures</span><span class="p">)</span>
    <span class="c1"># Launch the export of the results after the measures were extracted.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">measures_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">miow</span><span class="o">.</span><span class="n">export_results</span><span class="p">)</span>
    <span class="c1"># Launch the chain: background extraction -&gt; tracking -&gt; measures extraction</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">start_extract_background</span><span class="p">()</span>

    <span class="c1"># ---</span>
    <span class="n">napari</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">launch_test_procedure_2</span><span class="p">():</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
    <span class="n">miow</span>   <span class="o">=</span> <span class="n">MouseInOutWidget</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">add_dock_widget</span><span class="p">(</span><span class="n">miow</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Workflow: R6S6R7S7_01.09.20.mp4 ---&quot;</span><span class="p">)</span>

    <span class="n">media_path</span> <span class="o">=</span> <span class="s2">&quot;/home/benedetti/Documents/projects/25-entry-exit-mouse-monitor/data-samples/R6S6R7S7_01.09.20.mp4&quot;</span>

    <span class="c1"># Set experimental video.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">set_media</span><span class="p">(</span><span class="n">media_path</span><span class="p">)</span>

    <span class="c1"># Add boxes...</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">397.31629783</span><span class="p">,</span>  <span class="mf">44.22604657</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">397.31629783</span><span class="p">,</span> <span class="mf">173.37378185</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">233.09827237</span><span class="p">,</span> <span class="mf">173.37378185</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">233.09827237</span><span class="p">,</span>  <span class="mf">44.22604657</span><span class="p">]])</span>
    
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">395.64628401</span><span class="p">,</span> <span class="mf">186.73389239</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">395.64628401</span><span class="p">,</span> <span class="mf">320.33499785</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">231.42825855</span><span class="p">,</span> <span class="mf">320.33499785</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">231.42825855</span><span class="p">,</span> <span class="mf">186.73389239</span><span class="p">]])</span>
    
    <span class="n">b3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">395.08961273</span><span class="p">,</span> <span class="mf">331.46842331</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">395.08961273</span><span class="p">,</span> <span class="mf">464.51285749</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">229.75824473</span><span class="p">,</span> <span class="mf">464.51285749</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">229.75824473</span><span class="p">,</span> <span class="mf">331.46842331</span><span class="p">]])</span>
    
    <span class="n">b4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">388.96622873</span><span class="p">,</span> <span class="mf">473.97626913</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">388.96622873</span><span class="p">,</span> <span class="mf">600.89731931</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">228.64490219</span><span class="p">,</span> <span class="mf">600.89731931</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">228.64490219</span><span class="p">,</span> <span class="mf">473.97626913</span><span class="p">]])</span>
    
    <span class="n">boxes</span>  <span class="o">=</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">]</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3712</span><span class="p">,</span> <span class="mi">3712</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">162</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#c01c28&#39;</span><span class="p">,</span> <span class="s1">&#39;#f5c211&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ec27e&#39;</span><span class="p">,</span> <span class="s1">&#39;#1c71d8&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">boxes</span><span class="p">)):</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">add_row</span><span class="p">()</span>
        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">]</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">make_start_frame</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> 
            <span class="n">miow</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">miow</span><span class="o">.</span><span class="n">select_color</span><span class="p">(</span>
            <span class="n">index</span><span class="p">,</span> 
            <span class="n">miow</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
            <span class="n">QColor</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="p">)</span>


    <span class="c1"># Setting min area and threshold value for the mask.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">min_area</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span>

    <span class="c1"># Launch the tracking after the background extraction</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">background_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">miow</span><span class="o">.</span><span class="n">launch_tracking</span><span class="p">)</span>
    <span class="c1"># Launch measures extraction after the tracking was done.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">tracking_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">miow</span><span class="o">.</span><span class="n">extract_measures</span><span class="p">)</span>
    <span class="c1"># Launch the export of the results after the measures were extracted.</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">measures_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">miow</span><span class="o">.</span><span class="n">export_results</span><span class="p">)</span>
    <span class="c1"># Launch the chain: background extraction -&gt; tracking -&gt; measures extraction</span>
    <span class="n">miow</span><span class="o">.</span><span class="n">start_extract_background</span><span class="p">()</span>

    <span class="c1"># ---</span>
    <span class="n">napari</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">launch</span><span class="p">():</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
    <span class="n">miow</span>   <span class="o">=</span> <span class="n">MouseInOutWidget</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">add_dock_widget</span><span class="p">(</span><span class="n">miow</span><span class="p">)</span>

    <span class="c1"># ---</span>
    <span class="n">napari</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># launch()</span>
    <span class="c1"># launch_test_procedure_1()</span>
    <span class="n">launch_test_procedure_2</span><span class="p">()</span>



<span class="sd">&quot;&quot;&quot; UNIT TESTS</span>

<span class="sd">----&gt; MediaManager</span>

<span class="sd">    - On ne peut pas faire set_frame si aucun media n&#39;est ouvert.</span>
<span class="sd">    - On ne peut pas faire next_frame si aucun media n&#39;est ouvert.</span>
<span class="sd">    - On ne peut pas faire previous_frame si aucun media n&#39;est ouvert.</span>
<span class="sd">    - On ne peut pas appeler set_frame avec un index invalide.</span>
<span class="sd">    - On ne peut pas ouvrir plusieurs fois la même source.</span>
<span class="sd">    - Appeler n&#39;importe la quelle des méthodes pour changer de frame actualise les autres.</span>

<span class="sd">----&gt; Tracking</span>
<span class="sd">    - On ne peut pas lancer de process s&#39;il n&#39;y a aucune box sélectionnée.</span>
<span class="sd">    - Un layer de boite ne devrait contenir qu&#39;un objet.</span>
<span class="sd">    - On ne peut pas lancer de process si chaque box n&#39;a pas de start frame.</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Clément H. Benedetti.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>